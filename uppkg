#!/bin/bash -e

pkgdir="$1"
stat_f="$2"
pkgname="s-util"
gitroot='git://github.com/yuyichao/s-util.git'

cd "$pkgdir"

{
    read predate
    read prerel
    read presec
    read prever
} < "${stat_f}"

if [ -d "src/${pkgname}" ] ;then
    cd "src/${pkgname}" && git pull orgin
else
    mkdir -p src
    cd src
    git clone "${gitroot}"
    cd "${pkgname}"
fi

git checkout master

nwst_tg=$(git tag -l | tail -1)
nwst_dt=$(git log --pretty=format:%ct -1)

((day = nwst_dt / 86400))

curdate=$(date +%Y%m%d)

_mkinstl()
{
    local pkgdir="$1" srcdir="$2"
    cat > "${pkgdir}/s-util.install" <<EOF
post_install()
{
$()
post_instl /etc/bash.bashrc /usr/bin
}
pre_remove()
{
$(type pre_rm | awk 'NR > 1')
pre_rm /usr/share/sutil
}
EOF
}

if [[ "$presec" < "$nwst_dt" ]] ;then
    
else
    currel="$prerel"
    curdate="$predate"
    nwst_dt="$predate"
fi

if [[ "$nwst_tg" != "$prever" ]] ;then
    git checkout "${nwst_tg}"
fi


[[ $mkpkg_git == 1 ]] && {
    {
	echo "pkgver=${pkgver}"
	echo "pkgrel=${pkgrel}"
	cat
    } < "${s_srcdir}/_PKGBUILD-git" > "${currentdir}/PKGBUILD"
    _mkinstl "${currentdir}"
    exit
}

cat > "${varlst}" <<EOF
${_S_INSTALL_DIST}
${_S_BASH_RC}
EOF
